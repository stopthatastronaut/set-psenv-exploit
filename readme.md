# Set-PSEnv Vulnerability summary

Date: 1 July 2020
Reported by: [@cloudyopspoet](https://twitter.com/cloudyopspoet)

Vulnerability type: code injection, run arbitrary code as user

[Set-PSEnv](https://www.powershellgallery.com/packages/Set-PsEnv/0.0.3) is a Powershell module on the PS Gallery, useful to Developers and DevOps engineers to store environment variables in `.env` files. If used as recommended, it scans a `.env` file when executing a `cd` into the target directory while running interactively.

The developer recommends you run this in powershell's built-in `prompt()` function. However, it appears to have a vulnerability in how it parses a given file and sets the subsequent environment vars, in that a malicious developer could inject exploit code into, for example, a git repo, and have arbitrary code executed when an affected user switches working path into that repo's clone.

*TL;DR:* imagine running `cd ./newinterestingrepo` and suddenly your entire home folder is gone and that dodgy passwords.txt file you've felt guilty about for ages has been IRM'd to a web server in Azerbaijan.

## Repro steps

It is recommended you run these steps in a VM.

#### get set up

- Start a new powershell session. You may need the `-noprofile` switch if, like me, you already have stuff in `prompt()`
- Clone this repo
- create a file in your home directory called 'psenvcanaryfile.txt' with any content you like
- Install the Set-PSEnv module with `Install-Module "Set-PSEnv"`
- set it up to run automatically, as recommended in [the Set-PSEnv repo](https://github.com/rajivharris/Set-PsEnv), by executing the following:

```powershell
function prompt { Set-PSEnv -verbose }
```

- if this is working, you should see some verbose output every time you run a command. usually it'll say 'skipping same dir'. It is now set up as the developer recommends, with the saucy addition of the verbose output.

#### execute the actual exploit

- cd into the 'exploit' folder of this repo
- you should see output similar to `VERBOSE: Performing the operation "Execute" on target "$Env:EXPLOIT_ENV_VAR = "nothing";Remove-Item $home/setpsenvcanaryfile.txt -force; """`
- you should see that the 'setpsenvcanaryfile.txt' file in your home directory is deleted

This means that any arbitrary code can be executed in the context of the current user _just by switching into a directory which contains a poisoned `.env` file_.

## Recommendations

- Set-PSEnv should remove its dependency on `Invoke-Expression` ASAP.
- Users should refrain from using this Module while this vulnerability exists.
- Affected versions should be pulled from the PSGallery
